+++
title = "Высокодоступный MySQL"
outputs = ["Reveal"]
+++

# MySync

Высокодоступный MySQL на конвеере

---

### Какую проблему решаем ?

У нас свыше 2k кластеров в 5 датацентрах.

Кластера постоянно изменяются и апгрейдятся.

Железо под кластерам ломается и обслуживается.

В датацентрах происходят учения.

Нужно уметь сохранять кластер доступным на запись.

---

### Какие есть решения ?

* ServeralNines ClusterControl - платный

* Github Orchestrator - не тиражируется

* MySQL Group Replication - ?

* MHA - ?

* MySync !

---

### Пример использования

```
mysync maint on|off

mysync switch --to replica2

mysync switch --from master

mysync info -s
```

---

### Архитектура и основные принципы

* Все хосты эквиваленты

* Master / Manager

* Идемпотентность

* Loose no data!

(Картинка со схемой)

---

### Процесс switchover

* На каждой итерации поддерживается список active хостов.

* При switchover выбирается наиболее актуальный (по данным) из active.

* Ожидаем когда он догонится.

* Поворачиваем оставшиеся реплики на новый мастер.

* Promote!

---

### Проверка состояния кластера

Есть соединение с DCS - есть сеть.

Выполняется SELECT 1 - MySQL жив.

Но есть 99 способов ошибится в обе стороны:

* Файловая система в RO

* Исчерпание ресурсов

* Проблемы с DCS

---

### Про синхронную репликацию

Все DML - точно такие же обычно.

COMMIT - медленный, минимум RTT между ДЦ (autocommit - зло).

Наше обещание: Любая транзакция которая была закомичена - не будет потеряна.

---

### Характеристики

* Время Failover ~ 1мин

* Без потери данных!

* Последовательная деградация от N до 1 хоста

---

### Как все испортить

* Долгие транзакции

* Большие транзакции

* Отстающиее реплики

* Ненадеждая конфигурация

---

### Ненадеждная конфигурация

```
sync_binlog = 0 | 1000

innodb_flush_log_at_trx_commit = 0 | 2
```

---

### Как ускорить репликацию

* Не делать крупных транзакций!

```
slave_rows_search_algorithms = INDEX_SCAN,HASH_SCAN

slave_parallel_workers = 16

slave_parallel_type = LOGICAL_CLOCK

binlog_transaction_dependency_tracking = COMMIT_ORDER
```
---

### И это все что нужно ? 

Ну конечно нет!

* Переналивка сломаных хостов (соглашение про touch-file)

* Приложение должно находить PRIMARY

* Резервное копирование + PITR

---

### Долнительные фичи

* "Починка" кластера

* Управление свободным местом

* Управление видимостью отстающих реплик

* Каскадные реплики

* Приоритеты хостов

---

### Какие планы ?

* Поддержка асинхронной репликации

* Поддержка каналов репликации

* Поддержка MariaDB

* LibMysync ? 

---

### Как скачать и попробовать

https://github.com/yandex/mysync

